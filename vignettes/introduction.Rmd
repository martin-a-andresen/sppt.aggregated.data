---
title: "Introduction to sppt.aggregated.data"
author: "Martin A. Andresen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to sppt.aggregated.data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

# Introduction

The `sppt.aggregated.data` package provides tools for performing spatial pattern point tests on aggregated count data. The main function, `sppt()`, uses bootstrap resampling to compare spatial distributions between variables and quantify spatial pattern overlap using S-Index metrics.

## Installation

```{r eval=FALSE}
# Install from GitHub
install.packages("devtools")
devtools::install_github("yourusername/sppt.aggregated.data")
```

```{r}
library(sppt.aggregated.data)
library(sf)
library(dplyr)
```

# Basic Concepts

## What is SPPT?

Spatial Pattern Point Test (SPPT) is a method for comparing the spatial distributions of count data across different time periods or conditions. It uses bootstrap resampling to generate confidence intervals for each spatial unit, then determines if spatial patterns have changed significantly.

## Key Features

1. **Bootstrap Resampling**: Generates confidence intervals through repeated random sampling
2. **S-Index Metrics**: Quantifies spatial pattern overlap
3. **Flexible Comparisons**: Compare percentages (spatial distribution) or absolute counts
4. **Multiple Export Formats**: Save results as shapefiles, CSV, RDS, or GeoPackage
5. **Visualization**: Automatic map generation for bivariate comparisons

# Core Functionality

## The sppt() Function

The `sppt()` function is the main workhorse of the package. Here's what it does:

### Single Variable Analysis

When you provide a single variable in `count_col`, the function:

1. Expands the aggregated counts to individual events
2. Performs bootstrap resampling (default B = 200 samples)
3. Calculates confidence intervals for each spatial group
4. Returns the data with added columns: `{variable}_L` (lower) and `{variable}_U` (upper)

### Multiple Variable Analysis

When you provide multiple variables (typically two), the function:

1. Processes each variable independently
2. Calculates overlap statistics between confidence intervals
3. Generates the S-Index and Robust S-Index
4. Creates bivariate comparison maps (optional)
5. Exports results in your preferred format (optional)

# Working with the Function

## Understanding Parameters

### Core Parameters

- **data**: Your spatial data (sf object or data frame)
- **group_col**: Column identifying spatial units (e.g., census tracts, neighborhoods)
- **count_col**: Column(s) with count data (vector for multiple variables)
- **B**: Number of bootstrap samples (default: 200)
  - More samples = more stable estimates but slower computation
  - Recommended: 100-200 for small datasets, 500-1000 for large datasets

### Analysis Options

- **use_percentages**: 
  - `TRUE` (default): Compares spatial distributions (percentages)
  - `FALSE`: Compares absolute counts
  - **When to use each**: Use percentages when total counts differ between variables (e.g., comparing 2010 vs 2020 with population growth). Use counts when totals are similar or absolute differences matter.

- **fix_base**: 
  - `FALSE` (default): Bootstrap both variables
  - `TRUE`: Fix the first (base) variable, only bootstrap the second (test) variable
  - **Use case**: When you have known baseline data and uncertain test data

- **check_overlap**:
  - `FALSE` (default): Just calculate confidence intervals
  - `TRUE`: Calculate S-Index metrics and overlap statistics
  - **Recommendation**: Always set to `TRUE` when comparing two variables

### Visualization Options

- **create_maps**: Generate maps for bivariate comparisons (default: TRUE)
- **export_maps**: Save maps to disk (default: FALSE)
- **export_dir**: Directory for map exports
- **map_dpi**: Resolution for exported maps (default: 300, use 600 for publication)

### Export Options

- **export_results**: Save results to file (default: FALSE)
- **export_format**: File format - "shp", "csv", "txt", "rds", "gpkg" (default: "shp")
- **export_results_dir**: Directory for results export

# Practical Examples

## Example 1: Basic Single Variable Analysis

```{r eval=FALSE}
# Load your spatial data
data <- st_read("your_shapefile.shp")

# Calculate confidence intervals for one variable
result <- sppt(
  data = data,
  group_col = "DAUID",
  count_col = "Crime_Count",
  B = 200,
  seed = 123
)

# View the results
head(result[, c("DAUID", "Crime_Count", "Crime_Count_L", "Crime_Count_U")])
```

**What you get**: Original data plus lower (_L) and upper (_U) confidence bounds for each spatial unit.

## Example 2: Comparing Two Time Periods

This is the most common use case - comparing the same phenomenon across two time periods.

```{r eval=FALSE}
# Compare crime in 2020 vs 2021
result <- sppt(
  data = data,
  group_col = "DAUID",
  count_col = c("Crime_2020", "Crime_2021"),
  B = 200,
  check_overlap = TRUE,
  seed = 123
)

# Access S-Index statistics
s_index <- attr(result, "s_index")
robust_s_index <- attr(result, "robust_s_index")

cat("S-Index:", s_index, "\n")
cat("Robust S-Index:", robust_s_index, "\n")
```

**Output includes**:
- Confidence intervals for both variables
- `intervals_overlap`: 1 if intervals overlap, 0 if they don't
- `SIndex_Bivariate`: -1 (2020 > 2021), 0 (no difference), 1 (2021 > 2020)
- Printed S-Index statistics

## Example 3: Using Counts Instead of Percentages

```{r eval=FALSE}
# When you want to detect absolute changes, not distributional shifts
result <- sppt(
  data = data,
  group_col = "DAUID",
  count_col = c("Base", "Test"),
  B = 200,
  use_percentages = FALSE,  # Key difference!
  check_overlap = TRUE,
  seed = 123
)
```

**When to use**:
- Total counts are similar between variables
- Absolute differences matter more than proportional changes
- Analyzing subsets where total population hasn't changed

## Example 4: Fixed Base Variable

```{r eval=FALSE}
# When baseline data is certain (e.g., official census) but test data is uncertain
result <- sppt(
  data = data,
  group_col = "DAUID",
  count_col = c("Census_Official", "Survey_Estimate"),
  B = 200,
  fix_base = TRUE,  # Don't bootstrap the census data
  check_overlap = TRUE,
  seed = 123
)
```

**Use case**: Comparing known official statistics against estimates or predictions.

## Example 5: Complete Analysis with Exports

```{r eval=FALSE}
result <- sppt(
  data = data,
  group_col = "DAUID",
  count_col = c("TFV", "TOV"),
  B = 500,  # More samples for better estimates
  conf_level = 0.95,
  check_overlap = TRUE,
  fix_base = FALSE,
  use_percentages = TRUE,
  create_maps = TRUE,
  export_maps = TRUE,
  export_dir = "output/maps/",
  map_dpi = 600,  # High resolution for publication
  export_results = TRUE,
  export_format = "gpkg",  # Better than shapefile for large data
  export_results_dir = "output/data/",
  seed = 171717
)
```

**This creates**:
- High-resolution map showing spatial patterns
- GeoPackage file with all results and attributes
- Printed S-Index statistics

# Understanding the Output

## Output Columns

After running `sppt()`, your data will have these new columns:

- **{variable}_L**: Lower bound of 95% confidence interval
- **{variable}_U**: Upper bound of 95% confidence interval
- **intervals_overlap** (if `check_overlap = TRUE`): Binary indicator
  - 1 = Confidence intervals overlap (no significant difference)
  - 0 = Confidence intervals don't overlap (significant difference)
- **SIndex_Bivariate** (for two variables): Categorical indicator
  - -1 = Base variable > Test variable
  - 0 = No significant difference
  - 1 = Test variable > Base variable

## Interpreting S-Index

The **S-Index** measures the proportion of spatial units where confidence intervals overlap:

- **S-Index = 1.0**: Perfect overlap - no spatial pattern change
- **S-Index = 0.5**: Half the areas show change, half don't
- **S-Index = 0.0**: Complete spatial difference

The **Robust S-Index** is the same calculation but excludes spatial units where all variables are zero. This is more meaningful when many areas have no events.

### Example Interpretation

```
S-Index:          0.7234
Robust S-Index:   0.6891
Total observations:                482
Observations with overlap:         349
Observations with non-zero counts: 410
```

**Interpretation**: 
- 72% of all spatial units show no significant change in spatial pattern
- When excluding empty areas, 69% show no change
- 349 out of 482 areas have overlapping confidence intervals
- 72 areas have zero counts for both variables

## Map Interpretation

When comparing two variables, the map uses three colors:

- **Gray**: Base variable significantly greater than Test variable
- **White**: No significant difference (intervals overlap)
- **Black**: Test variable significantly greater than Base variable

# Advanced Usage

## Working with Large Datasets

For large datasets:

```{r eval=FALSE}
# Reduce bootstrap samples if needed
result <- sppt(data, count_col = c("A", "B"), B = 100)

# Or increase for more precision
result <- sppt(data, count_col = c("A", "B"), B = 1000)
```

**Performance tip**: Processing time increases linearly with B. For datasets with >100,000 events, start with B = 100 for testing.

## Comparing Multiple Pairs

If you need to compare multiple variable pairs:

```{r eval=FALSE}
# Create a function to process multiple comparisons
compare_vars <- function(data, var1, var2) {
  result <- sppt(
    data = data,
    group_col = "DAUID",
    count_col = c(var1, var2),
    B = 200,
    check_overlap = TRUE,
    seed = 123
  )
  
  list(
    data = result,
    s_index = attr(result, "s_index"),
    robust_s_index = attr(result, "robust_s_index")
  )
}

# Run multiple comparisons
comp1 <- compare_vars(data, "Var_2010", "Var_2015")
comp2 <- compare_vars(data, "Var_2015", "Var_2020")

# Compare S-Indices
cat("2010 vs 2015 S-Index:", comp1$s_index, "\n")
cat("2015 vs 2020 S-Index:", comp2$s_index, "\n")
```

## Custom Confidence Levels

```{r eval=FALSE}
# Use 90% confidence intervals instead of 95%
result <- sppt(
  data = data,
  group_col = "DAUID",
  count_col = c("Base", "Test"),
  conf_level = 0.90,  # Less conservative
  B = 200,
  check_overlap = TRUE
)

# Or use 99% for more conservative estimates
result <- sppt(
  data = data,
  group_col = "DAUID",
  count_col = c("Base", "Test"),
  conf_level = 0.99,  # More conservative
  B = 200,
  check_overlap = TRUE
)
```

# Export Formats

## Choosing the Right Format

### Shapefile (.shp)
```{r eval=FALSE}
result <- sppt(data, count_col = c("A", "B"), 
               export_results = TRUE, export_format = "shp")
```
- **Pros**: Universal compatibility with GIS software
- **Cons**: 2GB file size limit, attribute name length limit (10 chars)
- **Best for**: Sharing with others, using in ArcGIS/QGIS

### GeoPackage (.gpkg)
```{r eval=FALSE}
result <- sppt(data, count_col = c("A", "B"), 
               export_results = TRUE, export_format = "gpkg")
```
- **Pros**: No size limits, faster than shapefile, stores CRS better
- **Cons**: Less universal than shapefile (though increasingly supported)
- **Best for**: Large datasets, modern GIS workflows

### CSV (.csv)
```{r eval=FALSE}
result <- sppt(data, count_col = c("A", "B"), 
               export_results = TRUE, export_format = "csv")
```
- **Pros**: Opens in Excel, lightweight, no spatial software needed
- **Cons**: Loses geometry information
- **Best for**: Statistical analysis, sharing tabular results

### RDS (.rds)
```{r eval=FALSE}
result <- sppt(data, count_col = c("A", "B"), 
               export_results = TRUE, export_format = "rds")
```
- **Pros**: Preserves ALL R object attributes, fast to read/write
- **Cons**: R-specific format
- **Best for**: Saving for later analysis in R, preserving all metadata

# Troubleshooting

## Common Issues

### Issue: "Required packages missing"

**Solution**: Install missing packages
```{r eval=FALSE}
install.packages(c("Matrix", "dplyr", "tidyr", "rlang", "sf"))
```

### Issue: Long processing time

**Causes**:
1. Large number of events (high counts)
2. Too many bootstrap samples (high B)
3. Large number of spatial units

**Solutions**:
```{r eval=FALSE}
# Reduce bootstrap samples
result <- sppt(data, count_col = "Var", B = 100)  # Instead of 200

# Or test on a subset first
sample_data <- data[sample(nrow(data), 100), ]
result <- sppt(sample_data, count_col = c("A", "B"))
```

### Issue: "Cannot export as shapefile: data is not an sf object"

**Solution**: Convert your data to sf object first
```{r eval=FALSE}
library(sf)
data_sf <- st_as_sf(data, coords = c("lon", "lat"), crs = 4326)
result <- sppt(data_sf, count_col = c("A", "B"), 
               export_results = TRUE, export_format = "shp")
```

### Issue: Memory errors with large datasets

**Solutions**:
```{r eval=FALSE}
# 1. Use lower B value
result <- sppt(data, count_col = c("A", "B"), B = 100)

# 2. Process in chunks
chunk1 <- sppt(data[1:1000, ], count_col = c("A", "B"))
chunk2 <- sppt(data[1001:2000, ], count_col = c("A", "B"))
result <- rbind(chunk1, chunk2)

# 3. Export as CSV to save memory
result <- sppt(data, count_col = c("A", "B"), 
               export_results = TRUE, export_format = "csv")
```

# Best Practices

## 1. Always Set a Seed

For reproducible results:
```{r eval=FALSE}
result <- sppt(data, count_col = c("A", "B"), seed = 123)
```

## 2. Choose B Appropriately

- Small exploratory analysis: B = 100
- Standard analysis: B = 200
- Publication-quality: B = 500-1000

## 3. Check Your Data First

```{r eval=FALSE}
# Check for missing values
summary(data$count_col)

# Check for zeros
table(data$count_col == 0)

# Check total counts
sum(data$var1)
sum(data$var2)
```

## 4. Use Descriptive Variable Names

```{r eval=FALSE}
# Good
result <- sppt(data, count_col = c("Crime_2020", "Crime_2021"))

# Less clear
result <- sppt(data, count_col = c("Var1", "Var2"))
```

## 5. Document Your Analysis

```{r eval=FALSE}
# Save parameters with results
analysis_params <- list(
  date = Sys.Date(),
  B = 200,
  seed = 123,
  conf_level = 0.95,
  use_percentages = TRUE
)

saveRDS(list(results = result, params = analysis_params), 
        "my_analysis.rds")
```

# Real-World Example: Crime Analysis

Here's a complete workflow for analyzing crime pattern changes:

```{r eval=FALSE}
# Load crime data by census tract
library(sppt.aggregated.data)
library(sf)

data <- st_read("Vancouver_Crime_DAs.shp")

# Compare Total Family Violence (TFV) vs Total Other Violence (TOV)
result <- sppt(
  data = data,
  group_col = "DAUID",  # Census Dissemination Area ID
  count_col = c("TFV", "TOV"),
  B = 500,  # More samples for robust estimates
  conf_level = 0.95,
  check_overlap = TRUE,
  fix_base = FALSE,  # Bootstrap both variables
  use_percentages = TRUE,  # Compare spatial distributions
  create_maps = TRUE,
  export_maps = TRUE,
  export_dir = "output/crime_maps/",
  map_dpi = 600,  # High resolution
  export_results = TRUE,
  export_format = "gpkg",  # Modern format, no size limits
  export_results_dir = "output/crime_data/",
  seed = 171717  # For reproducibility
)

# Examine results
cat("\n=== Crime Pattern Analysis ===\n")
cat("S-Index:", attr(result, "s_index"), "\n")
cat("Robust S-Index:", attr(result, "robust_s_index"), "\n")

# Analyze areas with significant changes
significant_change <- result %>%
  filter(intervals_overlap == 0)

cat("\nAreas with significant change:", nrow(significant_change), "\n")

# Areas where TOV increased more than TFV
tov_increase <- result %>%
  filter(SIndex_Bivariate == 1)

cat("Areas with greater TOV increase:", nrow(tov_increase), "\n")
```

# Conclusion

The `sppt.aggregated.data` package provides a robust framework for comparing spatial patterns in aggregated count data. Key takeaways:

1. Use **percentages** for distributional comparisons, **counts** for absolute comparisons
2. Set `check_overlap = TRUE` when comparing two variables
3. The **S-Index** quantifies overall spatial pattern similarity
4. **Bootstrap resampling** provides confidence intervals without parametric assumptions
5. Export results in the format best suited for your workflow

For more information, visit the package repository or file an issue on GitHub.

# References

For more on spatial pattern analysis and bootstrap methods, see:

- Efron, B., & Tibshirani, R. J. (1994). An Introduction to the Bootstrap. CRC press.
- O'Sullivan, D., & Unwin, D. (2010). Geographic Information Analysis. John Wiley & Sons.

---

**Package Version**: 0.1.0  
**Last Updated**: `r Sys.Date()`
